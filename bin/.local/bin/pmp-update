#!/usr/bin/env bash

set -o errexit nounset

cleanup() { rm -f "$tempfile"; }
trap cleanup EXIT

tempfile="$(mktemp)"
url="https://knapsu.eu/data/plex/latest"
pmp_appimage="$HOME"/.local/bin/Plex_Media_Player.AppImage
logfile="$HOME"/Downloads/pmp-updated.log

wget --no-verbose --output-document="$tempfile" "$url" --output-file="${logfile}"

md5_new='' md5_cur=''
[[ -e "$tempfile" ]] && md5_new="$(md5sum "$tempfile" | awk '{print $1}')"
[[ -e "$pmp_appimage" ]] && md5_cur="$(md5sum "$pmp_appimage" | awk '{print $1}')"

if [[ "$md5_new" != "$md5_cur" ]]; then
  pmp_pid="$(pgrep plexmediaplayer)" && kill "$pmp_pid"
  [[ -e "$pmp_appimage" ]] && rm "$pmp_appimage"
  mv "$tempfile" "$pmp_appimage"
  chmod 0755 "$pmp_appimage"
fi

exit 0